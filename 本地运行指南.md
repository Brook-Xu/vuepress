# 后端项目本地运行指南

## 前置要求

在开始之前，请确保已安装以下软件：

1. **Node.js** - 版本建议 v14 或更高
   - 下载地址：https://nodejs.org/
   - 安装后验证：`node --version` 和 `npm --version`

2. **MySQL 数据库**
   - 可以使用本地 MySQL 或阿里云 ApsaraDB RDS
   - 本地安装：https://dev.mysql.com/downloads/mysql/
   - 或使用 Docker：`docker run --name mysql -e MYSQL_ROOT_PASSWORD=yourpassword -p 3306:3306 -d mysql:8.0`

3. **Redis 服务**
   - 可以使用本地 Redis 或阿里云 ApsaraDB for Redis
   - 本地安装：https://redis.io/download
   - 或使用 Docker：`docker run --name redis -p 6379:6379 -d redis:7-alpine`

4. **SMTP 邮件服务**（可选，用于发送验证码）
   - 可以使用阿里云 DirectMail 或其他 SMTP 服务
   - 如果暂时不需要邮件功能，可以跳过此配置

---

## 快速开始（5步）

### 1. 进入项目目录

```bash
cd alibaba-auth-backend
```

### 2. 安装依赖

```bash
npm install
```

> 如果安装速度慢，可以使用国内镜像：
> ```bash
> npm install --registry=https://registry.npmmirror.com
> ```

### 3. 配置环境变量

在项目根目录创建 `.env` 文件，复制以下模板并填入你的配置：

```env
# 服务器配置
PORT=3000

# JWT 配置
JWT_SECRET=your_jwt_secret_key_change_this_in_production
JWT_EXPIRES_IN=1d

# MySQL 数据库配置
DB_HOST=localhost
DB_PORT=3306
DB_NAME=your_database_name
DB_USER=your_mysql_username
DB_PASS=your_mysql_password

# Redis 配置
REDIS_HOST=localhost
REDIS_PORT=6379
REDIS_PASS=

# SMTP 配置（阿里云 DirectMail 或其他 SMTP 服务）
SMTP_HOST=smtpdm.aliyun.com
SMTP_PORT=465
SMTP_SECURE=true
SMTP_USER=your_smtp_username
SMTP_PASS=your_smtp_password

# 验证码过期时间（秒）
VERIFICATION_CODE_TTL_SECONDS=600    # 注册验证码有效期 10 分钟
RESET_CODE_TTL_SECONDS=900           # 重置密码验证码有效期 15 分钟
TOKEN_TTL_SECONDS=86400              # JWT 令牌有效期 24 小时

# CORS 配置（可选，多个源用逗号分隔）
ALLOWED_ORIGINS=http://localhost:8080,http://localhost:3000
```

### 4. 初始化数据库

**方式一：自动创建（推荐）**

直接启动服务，Sequelize 会自动创建 `users` 表。

**方式二：手动创建**

连接到 MySQL 数据库，执行 `init-db.sql` 文件：

```bash
mysql -h localhost -u your_user -p your_database < init-db.sql
```

或在 MySQL 客户端中执行：

```sql
CREATE TABLE IF NOT EXISTS `users` (
  `id` BIGINT UNSIGNED NOT NULL AUTO_INCREMENT,
  `email` VARCHAR(255) NOT NULL UNIQUE,
  `password_hash` VARCHAR(255) NOT NULL,
  `verified` TINYINT(1) NOT NULL DEFAULT 0,
  `created_at` TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  `updated_at` TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  PRIMARY KEY (`id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;
```

### 5. 启动服务

**开发模式（推荐，支持热重载）：**

```bash
npm run dev
```

**生产模式：**

```bash
npm start
```

启动成功后，你会看到类似以下输出：

```
MySQL: Connected successfully
MySQL: Tables synced
Redis: Connected and ready
SMTP: Transporter verified
Server: Listening on port 3000
```

---

## 详细配置说明

### MySQL 数据库配置

#### 本地 MySQL 配置示例

```env
DB_HOST=localhost
DB_PORT=3306
DB_NAME=auth_db
DB_USER=root
DB_PASS=your_password
```

#### 阿里云 ApsaraDB RDS 配置示例

```env
DB_HOST=rm-xxxxx.mysql.rds.aliyuncs.com
DB_PORT=3306
DB_NAME=your_database_name
DB_USER=your_username
DB_PASS=your_password
```

### Redis 配置

#### 本地 Redis 配置示例（无密码）

```env
REDIS_HOST=localhost
REDIS_PORT=6379
REDIS_PASS=
```

#### 本地 Redis 配置示例（有密码）

```env
REDIS_HOST=localhost
REDIS_PORT=6379
REDIS_PASS=your_redis_password
```

#### 阿里云 ApsaraDB for Redis 配置示例

```env
REDIS_HOST=r-xxxxx.redis.rds.aliyuncs.com
REDIS_PORT=6379
REDIS_PASS=your_redis_password
```

### SMTP 邮件配置

#### 阿里云 DirectMail 配置

1. 登录阿里云控制台
2. 开通 DirectMail 服务
3. 创建发信地址并获取 SMTP 配置信息

```env
SMTP_HOST=smtpdm.aliyun.com
SMTP_PORT=465
SMTP_SECURE=true
SMTP_USER=your_smtp_username
SMTP_PASS=your_smtp_password
```

#### 其他 SMTP 服务配置示例

**Gmail（需要应用专用密码）：**

```env
SMTP_HOST=smtp.gmail.com
SMTP_PORT=465
SMTP_SECURE=true
SMTP_USER=your_email@gmail.com
SMTP_PASS=your_app_specific_password
```

**QQ 邮箱：**

```env
SMTP_HOST=smtp.qq.com
SMTP_PORT=465
SMTP_SECURE=true
SMTP_USER=your_email@qq.com
SMTP_PASS=your_authorization_code
```

> **注意**：如果暂时不需要邮件功能，可以填写任意值，但服务启动时 SMTP 验证会失败（不影响其他功能）。

---

## 验证服务

### 1. 检查服务状态

访问根路径：

```bash
curl http://localhost:3000
```

或使用浏览器访问：http://localhost:3000

应该返回：

```json
{
  "ok": true,
  "message": "Alibaba Cloud Auth Backend",
  "db": "connected"
}
```

### 2. 健康检查

访问健康检查端点：

```bash
curl http://localhost:3000/health
```

应该返回：

```json
{
  "status": "ok",
  "db": "connected",
  "timestamp": "2024-01-01T00:00:00.000Z"
}
```

### 3. 测试 API 端点

**测试注册请求（发送验证码）：**

```bash
curl -X POST http://localhost:3000/api/auth/register/request \
  -H "Content-Type: application/json" \
  -d '{"email":"test@example.com","password":"password123"}'
```

---

## 常见问题

### 1. 数据库连接失败

**错误信息：**
```
MySQL: Connection failed Error: connect ECONNREFUSED
```

**解决方法：**
- 检查 MySQL 服务是否启动
- 验证 `.env` 文件中的数据库配置是否正确
- 检查数据库用户是否有远程连接权限（如果使用远程数据库）
- 确认防火墙是否允许连接

### 2. Redis 连接失败

**错误信息：**
```
Redis Client Error: connect ECONNREFUSED
```

**解决方法：**
- 检查 Redis 服务是否启动：`redis-cli ping`（应该返回 `PONG`）
- 验证 `.env` 文件中的 Redis 配置
- 如果 Redis 有密码，确保 `REDIS_PASS` 配置正确
- 检查 Redis 是否绑定到 `127.0.0.1`（本地）或 `0.0.0.0`（允许远程）

### 3. SMTP 验证失败

**错误信息：**
```
SMTP: Transporter verification failed
```

**解决方法：**
- 检查 SMTP 配置是否正确
- 验证 SMTP 用户名和密码
- 确认 SMTP 端口和加密设置（`SMTP_SECURE`）
- 如果暂时不需要邮件功能，可以忽略此错误（不影响其他功能）

### 4. 缺少必需的环境变量

**错误信息：**
```
Missing required environment variables: DB_HOST, DB_NAME, ...
```

**解决方法：**
- 确保 `.env` 文件存在于项目根目录
- 检查 `.env` 文件中是否包含所有必需的配置项
- 注意：`.env` 文件不应该提交到 Git（已在 `.gitignore` 中）

### 5. 端口被占用

**错误信息：**
```
Error: listen EADDRINUSE: address already in use :::3000
```

**解决方法：**
- 修改 `.env` 文件中的 `PORT` 为其他端口（如 `3001`）
- 或停止占用 3000 端口的其他服务

### 6. JWT_SECRET 警告

**错误信息：**
```
JWT_SECRET must be set in production environment
```

**解决方法：**
- 在生产环境中，必须设置一个强密码作为 `JWT_SECRET`
- 开发环境可以使用默认值，但建议也设置一个

---

## 项目结构

```
alibaba-auth-backend/
├── src/
│   ├── index.js          # 应用入口，Express 服务器配置
│   ├── config.js         # 配置管理（从环境变量读取）
│   ├── redis.js          # Redis 连接配置
│   ├── models/
│   │   └── user.js       # Sequelize 用户模型
│   ├── routes/
│   │   └── auth.js       # 认证相关路由
│   ├── middleware/
│   │   └── auth.js       # JWT 认证中间件
│   └── mail/
│       └── mailer.js     # 邮件发送服务
├── init-db.sql           # 数据库初始化脚本
├── package.json          # 项目配置和依赖
├── README.md             # 项目说明文档
└── .env                  # 环境变量配置（需要自己创建）
```

---

## API 端点

服务启动后，可用的 API 端点：

- `GET /` - 根路径，返回服务信息
- `GET /health` - 健康检查端点
- `POST /api/auth/register/request` - 注册请求（发送验证码）
- `POST /api/auth/register/verify` - 验证注册码
- `POST /api/auth/login` - 用户登录
- `POST /api/auth/logout` - 用户登出
- `POST /api/auth/password/forgot` - 忘记密码（请求重置码）
- `POST /api/auth/password/reset` - 重置密码
- `PUT /api/auth/password` - 修改密码（需要认证）

详细的 API 文档请参考 `README.md` 文件。

---

## 开发提示

1. **使用开发模式**：`npm run dev` 支持热重载，修改代码后自动重启
2. **查看日志**：所有请求都会在控制台输出日志
3. **数据库自动同步**：Sequelize 会自动创建和同步数据库表结构
4. **CORS 配置**：默认允许 `http://localhost:8080` 和 `http://localhost:3000`，可通过 `ALLOWED_ORIGINS` 环境变量配置

---

## 停止服务

在终端按 `Ctrl + C` 停止服务。

服务会优雅关闭，自动断开数据库和 Redis 连接。

---

## 下一步

- 查看 `README.md` 了解完整的 API 文档
- 配置前端项目连接到后端服务
- 根据实际需求调整环境变量配置

